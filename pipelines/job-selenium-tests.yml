jobs:
- job: TestWebsiteSelenium
  displayName: Test App with Selenium

  steps:
  - template: step-install-node.yml

  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: $(TF_ARTIFACT_NAME)
    displayName: Download Terraform output artifact

  - script: npm install
    displayName: Restore npm modules
    workingDirectory: ui-tests/selenium

  - script: npm run lint
    displayName: Lint JavaScript
    workingDirectory: ui-tests/selenium

  - script: |  
      cp $(TF_ARTIFACT_PATH)/$(TF_OUTPUT_VARS) .env
      npm test
    displayName: Run Selenium tests
    workingDirectory: ui-tests/selenium
    env:
      HEADLESS_CHROME: "true"

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    displayName: Publish test results
    inputs:
      testRunTitle: Selenium Tets Results
      testResultsFormat: JUnit
      testResultsFiles: ui-tests/selenium/test-results/*.xml

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    displayName: Publish Selenium results artifact
    inputs:
      pathToPublish: ui-tests/selenium/test-results
      ArtifactName: selenium-test-results-artifact-$(Build.BuildNumber)

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    displayName: Publish Selenium output artifact
    inputs:
      pathToPublish: ui-tests/selenium/selenium-output
      ArtifactName: selenium-output-artifact-$(Build.BuildNumber)    